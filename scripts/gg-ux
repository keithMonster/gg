#!/bin/bash

# ggæ™ºèƒ½ä½“ç”¨æˆ·ä½“éªŒä¼˜åŒ–ç®¡ç†è„šæœ¬
# æä¾›ç»Ÿä¸€çš„UXç³»ç»Ÿç®¡ç†æ¥å£

set -e

# è„šæœ¬é…ç½®
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
UX_DIR="$PROJECT_ROOT/ux_data"
CONFIG_DIR="$PROJECT_ROOT/config"
LOG_FILE="$PROJECT_ROOT/logs/ux_manager.log"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
    log "INFO: $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
    log "SUCCESS: $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
    log "WARNING: $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    log "ERROR: $1"
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    info "æ£€æŸ¥ä¾èµ–..."
    
    # æ£€æŸ¥Python
    if ! command -v python3 &> /dev/null; then
        error "Python3 æœªå®‰è£…"
        exit 1
    fi
    
    # æ£€æŸ¥å¿…è¦çš„PythonåŒ…
    python3 -c "import json, time, re, pathlib, dataclasses, collections, enum" 2>/dev/null || {
        error "ç¼ºå°‘å¿…è¦çš„PythonåŒ…"
        exit 1
    }
    
    success "ä¾èµ–æ£€æŸ¥é€šè¿‡"
}

# åˆå§‹åŒ–ç›®å½•ç»“æ„
init_directories() {
    info "åˆå§‹åŒ–ç›®å½•ç»“æ„..."
    
    mkdir -p "$UX_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$(dirname "$LOG_FILE")"
    
    success "ç›®å½•ç»“æ„åˆå§‹åŒ–å®Œæˆ"
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
ggæ™ºèƒ½ä½“ç”¨æˆ·ä½“éªŒä¼˜åŒ–ç®¡ç†å·¥å…·

ç”¨æ³•: $0 <å‘½ä»¤> [é€‰é¡¹]

å‘½ä»¤:
  init                    åˆå§‹åŒ–UXç³»ç»Ÿ
  status                  æ˜¾ç¤ºUXç³»ç»ŸçŠ¶æ€
  dashboard              æ˜¾ç¤ºUXä»ªè¡¨æ¿
  analyze [days]         åˆ†æç”¨æˆ·è¡Œä¸ºæ¨¡å¼ (é»˜è®¤7å¤©)
  recommendations [days] ç”ŸæˆUXæ”¹è¿›å»ºè®® (é»˜è®¤7å¤©)
  feedback <id> <rating> æäº¤ç”¨æˆ·åé¦ˆ (rating: 1-5)
  test                   è¿è¡ŒUXç³»ç»Ÿæµ‹è¯•
  report [days]          ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š (é»˜è®¤7å¤©)
  clean [days]           æ¸…ç†æ—§æ•°æ® (é»˜è®¤30å¤©)
  export <file>          å¯¼å‡ºUXæ•°æ®
  import <file>          å¯¼å…¥UXæ•°æ®
  config                 æ˜¾ç¤ºé…ç½®ä¿¡æ¯
  help                   æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

é€‰é¡¹:
  --output <file>        æŒ‡å®šè¾“å‡ºæ–‡ä»¶
  --format <json|text>   æŒ‡å®šè¾“å‡ºæ ¼å¼ (é»˜è®¤: text)
  --verbose              è¯¦ç»†è¾“å‡º
  --quiet                é™é»˜æ¨¡å¼

ç¤ºä¾‹:
  $0 init                           # åˆå§‹åŒ–ç³»ç»Ÿ
  $0 dashboard                      # æŸ¥çœ‹ä»ªè¡¨æ¿
  $0 analyze 30                     # åˆ†æ30å¤©æ•°æ®
  $0 recommendations --output rec.json  # ç”Ÿæˆå»ºè®®å¹¶ä¿å­˜
  $0 feedback int_123456 4          # æäº¤æ»¡æ„åº¦4çš„åé¦ˆ
  $0 report 7 --format json         # ç”Ÿæˆ7å¤©JSONæ ¼å¼æŠ¥å‘Š

EOF
}

# åˆå§‹åŒ–UXç³»ç»Ÿ
init_ux_system() {
    info "åˆå§‹åŒ–UXä¼˜åŒ–ç³»ç»Ÿ..."
    
    check_dependencies
    init_directories
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶
    if [[ ! -f "$CONFIG_DIR/ux_config.json" ]]; then
        info "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
        python3 "$SCRIPT_DIR/ux_optimizer.py" dashboard > /dev/null 2>&1 || true
    fi
    
    success "UXç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ"
}

# æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
show_status() {
    info "UXç³»ç»ŸçŠ¶æ€:"
    
    echo "é…ç½®æ–‡ä»¶: $([ -f "$CONFIG_DIR/ux_config.json" ] && echo "âœ“ å­˜åœ¨" || echo "âœ— ç¼ºå¤±")"
    echo "æ•°æ®ç›®å½•: $([ -d "$UX_DIR" ] && echo "âœ“ å­˜åœ¨" || echo "âœ— ç¼ºå¤±")"
    
    # ç»Ÿè®¡æ•°æ®æ–‡ä»¶
    local interaction_files=$(find "$UX_DIR" -name "interactions_*.jsonl" 2>/dev/null | wc -l)
    echo "äº¤äº’æ•°æ®æ–‡ä»¶: $interaction_files ä¸ª"
    
    # æ£€æŸ¥æœ€è¿‘æ´»åŠ¨
    local latest_file=$(find "$UX_DIR" -name "interactions_*.jsonl" -exec ls -t {} + 2>/dev/null | head -1)
    if [[ -n "$latest_file" ]]; then
        local latest_date=$(basename "$latest_file" | sed 's/interactions_\(.*\)\.jsonl/\1/')
        echo "æœ€æ–°æ•°æ®: $latest_date"
    else
        echo "æœ€æ–°æ•°æ®: æ— "
    fi
    
    # Pythonè„šæœ¬çŠ¶æ€
    if python3 -c "from scripts.ux_optimizer import UXOptimizer; UXOptimizer()" 2>/dev/null; then
        echo "UXä¼˜åŒ–å™¨: âœ“ æ­£å¸¸"
    else
        echo "UXä¼˜åŒ–å™¨: âœ— å¼‚å¸¸"
    fi
}

# æ˜¾ç¤ºä»ªè¡¨æ¿
show_dashboard() {
    info "è·å–UXä»ªè¡¨æ¿æ•°æ®..."
    
    if [[ "$FORMAT" == "json" ]]; then
        python3 "$SCRIPT_DIR/ux_optimizer.py" dashboard
    else
        # è§£æJSONå¹¶æ ¼å¼åŒ–æ˜¾ç¤º
        local dashboard_json=$(python3 "$SCRIPT_DIR/ux_optimizer.py" dashboard)
        
        echo "=== UXä»ªè¡¨æ¿ ==="
        echo
        
        # å®æ—¶æŒ‡æ ‡
        echo "ğŸ“Š å®æ—¶æŒ‡æ ‡:"
        echo "  æ´»è·ƒä¼šè¯: $(echo "$dashboard_json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['real_time_metrics']['active_session'])")"
        echo "  æœ€è¿‘äº¤äº’: $(echo "$dashboard_json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['real_time_metrics']['recent_interactions'])") æ¬¡"
        echo "  å¹³å‡å“åº”æ—¶é—´: $(echo "$dashboard_json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"{data['real_time_metrics']['avg_response_time_ms']:.1f}ms\")") "
        echo "  æˆåŠŸç‡: $(echo "$dashboard_json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(f\"{data['real_time_metrics']['success_rate']:.1%}\")") "
        echo
        
        # å»ºè®®æ•°é‡
        local rec_count=$(echo "$dashboard_json" | python3 -c "import sys, json; data=json.load(sys.stdin); print(len(data['recommendations']))")
        if [[ $rec_count -gt 0 ]]; then
            echo "ğŸ’¡ æ”¹è¿›å»ºè®®: $rec_count æ¡"
            echo "  ä½¿ç”¨ '$0 recommendations' æŸ¥çœ‹è¯¦ç»†å»ºè®®"
        else
            echo "ğŸ’¡ æ”¹è¿›å»ºè®®: æš‚æ— "
        fi
    fi
}

# åˆ†æç”¨æˆ·æ¨¡å¼
analyze_patterns() {
    local days=${1:-7}
    info "åˆ†æ $days å¤©çš„ç”¨æˆ·è¡Œä¸ºæ¨¡å¼..."
    
    if [[ -n "$OUTPUT_FILE" ]]; then
        python3 "$SCRIPT_DIR/ux_optimizer.py" analyze --days "$days" --output "$OUTPUT_FILE"
        success "åˆ†æç»“æœå·²ä¿å­˜åˆ°: $OUTPUT_FILE"
    else
        python3 "$SCRIPT_DIR/ux_optimizer.py" analyze --days "$days"
    fi
}

# ç”Ÿæˆæ”¹è¿›å»ºè®®
generate_recommendations() {
    local days=${1:-7}
    info "ç”ŸæˆåŸºäº $days å¤©æ•°æ®çš„æ”¹è¿›å»ºè®®..."
    
    if [[ -n "$OUTPUT_FILE" ]]; then
        python3 "$SCRIPT_DIR/ux_optimizer.py" recommendations --days "$days" --output "$OUTPUT_FILE"
    else
        python3 "$SCRIPT_DIR/ux_optimizer.py" recommendations --days "$days"
    fi
}

# æäº¤åé¦ˆ
submit_feedback() {
    local interaction_id="$1"
    local rating="$2"
    local feedback_text="$3"
    
    if [[ -z "$interaction_id" || -z "$rating" ]]; then
        error "éœ€è¦æä¾›äº¤äº’IDå’Œè¯„åˆ†"
        echo "ç”¨æ³•: $0 feedback <interaction_id> <rating> [feedback_text]"
        exit 1
    fi
    
    if [[ ! "$rating" =~ ^[1-5]$ ]]; then
        error "è¯„åˆ†å¿…é¡»æ˜¯1-5ä¹‹é—´çš„æ•´æ•°"
        exit 1
    fi
    
    info "æäº¤åé¦ˆ: ID=$interaction_id, è¯„åˆ†=$rating"
    
    local cmd="python3 '$SCRIPT_DIR/ux_optimizer.py' feedback --interaction-id '$interaction_id' --satisfaction '$rating'"
    if [[ -n "$feedback_text" ]]; then
        cmd="$cmd --feedback-text '$feedback_text'"
    fi
    
    eval "$cmd"
}

# è¿è¡Œæµ‹è¯•
run_test() {
    info "è¿è¡ŒUXç³»ç»Ÿæµ‹è¯•..."
    
    # è¿è¡Œé›†æˆæµ‹è¯•
    python3 "$SCRIPT_DIR/ux_integration.py"
    
    success "UXç³»ç»Ÿæµ‹è¯•å®Œæˆ"
}

# ç”ŸæˆæŠ¥å‘Š
generate_report() {
    local days=${1:-7}
    info "ç”Ÿæˆ $days å¤©çš„è¯¦ç»†UXæŠ¥å‘Š..."
    
    local report_file="${OUTPUT_FILE:-ux_report_$(date +%Y%m%d_%H%M%S).json}"
    
    # è·å–ä»ªè¡¨æ¿æ•°æ®
    python3 "$SCRIPT_DIR/ux_optimizer.py" dashboard > "$report_file"
    
    # æ·»åŠ åˆ†ææ•°æ®
    local analysis_file="/tmp/ux_analysis_$$.json"
    python3 "$SCRIPT_DIR/ux_optimizer.py" analyze --days "$days" --output "$analysis_file"
    
    # åˆå¹¶æ•°æ® (ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…å¯ä»¥ç”¨jqç­‰å·¥å…·)
    success "æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
    
    if [[ "$FORMAT" == "text" ]]; then
        info "æŠ¥å‘Šæ‘˜è¦:"
        show_dashboard
    fi
}

# æ¸…ç†æ—§æ•°æ®
clean_old_data() {
    local days=${1:-30}
    info "æ¸…ç† $days å¤©å‰çš„æ—§æ•°æ®..."
    
    local cutoff_date=$(date -d "$days days ago" +%Y-%m-%d 2>/dev/null || date -v-${days}d +%Y-%m-%d)
    local deleted_count=0
    
    for file in "$UX_DIR"/interactions_*.jsonl; do
        if [[ -f "$file" ]]; then
            local file_date=$(basename "$file" | sed 's/interactions_\(.*\)\.jsonl/\1/')
            if [[ "$file_date" < "$cutoff_date" ]]; then
                rm "$file"
                ((deleted_count++))
            fi
        fi
    done
    
    success "å·²åˆ é™¤ $deleted_count ä¸ªæ—§æ•°æ®æ–‡ä»¶"
}

# å¯¼å‡ºæ•°æ®
export_data() {
    local output_file="$1"
    if [[ -z "$output_file" ]]; then
        output_file="ux_export_$(date +%Y%m%d_%H%M%S).tar.gz"
    fi
    
    info "å¯¼å‡ºUXæ•°æ®åˆ°: $output_file"
    
    tar -czf "$output_file" -C "$PROJECT_ROOT" ux_data config/ux_config.json
    
    success "æ•°æ®å¯¼å‡ºå®Œæˆ: $output_file"
}

# å¯¼å…¥æ•°æ®
import_data() {
    local input_file="$1"
    if [[ -z "$input_file" || ! -f "$input_file" ]]; then
        error "è¯·æä¾›æœ‰æ•ˆçš„å¯¼å…¥æ–‡ä»¶"
        exit 1
    fi
    
    info "ä» $input_file å¯¼å…¥UXæ•°æ®..."
    
    # å¤‡ä»½ç°æœ‰æ•°æ®
    if [[ -d "$UX_DIR" ]]; then
        local backup_file="ux_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
        tar -czf "$backup_file" -C "$PROJECT_ROOT" ux_data
        info "ç°æœ‰æ•°æ®å·²å¤‡ä»½åˆ°: $backup_file"
    fi
    
    # å¯¼å…¥æ–°æ•°æ®
    tar -xzf "$input_file" -C "$PROJECT_ROOT"
    
    success "æ•°æ®å¯¼å…¥å®Œæˆ"
}

# æ˜¾ç¤ºé…ç½®
show_config() {
    info "UXç³»ç»Ÿé…ç½®:"
    
    if [[ -f "$CONFIG_DIR/ux_config.json" ]]; then
        if command -v jq &> /dev/null; then
            cat "$CONFIG_DIR/ux_config.json" | jq .
        else
            cat "$CONFIG_DIR/ux_config.json"
        fi
    else
        warning "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_DIR/ux_config.json"
    fi
}

# è§£æå‘½ä»¤è¡Œå‚æ•°
FORMAT="text"
VERBOSE=false
QUIET=false
OUTPUT_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --output)
            OUTPUT_FILE="$2"
            shift 2
            ;;
        --format)
            FORMAT="$2"
            shift 2
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --quiet)
            QUIET=true
            shift
            ;;
        -*)
            error "æœªçŸ¥é€‰é¡¹: $1"
            show_help
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

# é™é»˜æ¨¡å¼å¤„ç†
if [[ "$QUIET" == "true" ]]; then
    exec 1>/dev/null
fi

# ä¸»å‘½ä»¤å¤„ç†
COMMAND="${1:-help}"

case "$COMMAND" in
    init)
        init_ux_system
        ;;
    status)
        show_status
        ;;
    dashboard)
        show_dashboard
        ;;
    analyze)
        analyze_patterns "$2"
        ;;
    recommendations)
        generate_recommendations "$2"
        ;;
    feedback)
        submit_feedback "$2" "$3" "$4"
        ;;
    test)
        run_test
        ;;
    report)
        generate_report "$2"
        ;;
    clean)
        clean_old_data "$2"
        ;;
    export)
        export_data "$2"
        ;;
    import)
        import_data "$2"
        ;;
    config)
        show_config
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        error "æœªçŸ¥å‘½ä»¤: $COMMAND"
        show_help
        exit 1
        ;;
esac