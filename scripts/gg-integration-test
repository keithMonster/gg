#!/bin/bash

# ggæ™ºèƒ½ä½“ç³»ç»Ÿé›†æˆæµ‹è¯•è„šæœ¬
# æµ‹è¯•æ‰€æœ‰å­ç³»ç»Ÿçš„ååŒå·¥ä½œèƒ½åŠ›

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# åˆ‡æ¢åˆ°é¡¹ç›®æ ¹ç›®å½•
cd "$PROJECT_ROOT"

# æµ‹è¯•ç»“æœç»Ÿè®¡
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0
TEST_RESULTS=()

# è®°å½•æµ‹è¯•ç»“æœ
record_test() {
    local test_name="$1"
    local result="$2"
    local details="$3"
    
    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    
    if [ "$result" = "PASS" ]; then
        PASSED_TESTS=$((PASSED_TESTS + 1))
        log_success "âœ“ $test_name"
    else
        FAILED_TESTS=$((FAILED_TESTS + 1))
        log_error "âœ— $test_name: $details"
    fi
    
    TEST_RESULTS+=("$test_name: $result")
}

# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
check_system_status() {
    log_info "æ£€æŸ¥å„å­ç³»ç»ŸçŠ¶æ€..."
    
    # æ£€æŸ¥æŠ€èƒ½å‘ç°ç³»ç»Ÿ
    if ./scripts/gg-skill-discovery status > /dev/null 2>&1; then
        record_test "æŠ€èƒ½å‘ç°ç³»ç»ŸçŠ¶æ€" "PASS"
    else
        record_test "æŠ€èƒ½å‘ç°ç³»ç»ŸçŠ¶æ€" "FAIL" "ç³»ç»ŸçŠ¶æ€å¼‚å¸¸"
    fi
    
    # æ£€æŸ¥æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
    if ./scripts/gg-performance status > /dev/null 2>&1; then
        record_test "æ€§èƒ½ç›‘æ§ç³»ç»ŸçŠ¶æ€" "PASS"
    else
        record_test "æ€§èƒ½ç›‘æ§ç³»ç»ŸçŠ¶æ€" "FAIL" "ç³»ç»ŸçŠ¶æ€å¼‚å¸¸"
    fi
    
    # æ£€æŸ¥UXä¼˜åŒ–ç³»ç»Ÿ
    if ./scripts/gg-ux status > /dev/null 2>&1; then
        record_test "UXä¼˜åŒ–ç³»ç»ŸçŠ¶æ€" "PASS"
    else
        record_test "UXä¼˜åŒ–ç³»ç»ŸçŠ¶æ€" "FAIL" "ç³»ç»ŸçŠ¶æ€å¼‚å¸¸"
    fi
    
    # æ£€æŸ¥å®‰å…¨ç®¡ç†ç³»ç»Ÿ
    if ./scripts/gg-security status > /dev/null 2>&1; then
        record_test "å®‰å…¨ç®¡ç†ç³»ç»ŸçŠ¶æ€" "PASS"
    else
        record_test "å®‰å…¨ç®¡ç†ç³»ç»ŸçŠ¶æ€" "FAIL" "ç³»ç»ŸçŠ¶æ€å¼‚å¸¸"
    fi
    
    # æ£€æŸ¥çŸ¥è¯†å›¾è°±ç³»ç»Ÿ
    if ./scripts/gg-knowledge status > /dev/null 2>&1; then
        record_test "çŸ¥è¯†å›¾è°±ç³»ç»ŸçŠ¶æ€" "PASS"
    else
        record_test "çŸ¥è¯†å›¾è°±ç³»ç»ŸçŠ¶æ€" "FAIL" "ç³»ç»ŸçŠ¶æ€å¼‚å¸¸"
    fi
}

# æµ‹è¯•ç³»ç»Ÿé›†æˆ
test_system_integration() {
    log_info "æµ‹è¯•ç³»ç»Ÿé›†æˆåŠŸèƒ½..."
    
    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    local test_file="outputs/integration_test_$(date +%Y%m%d_%H%M%S).py"
    cat > "$test_file" << 'EOF'
#!/usr/bin/env python3
# é›†æˆæµ‹è¯•ç¤ºä¾‹ä»£ç 

import json
import time
from datetime import datetime

def test_function():
    """æµ‹è¯•å‡½æ•°"""
    data = {
        "timestamp": datetime.now().isoformat(),
        "test_id": "integration_test_001",
        "status": "running"
    }
    
    # æ¨¡æ‹Ÿä¸€äº›å¤„ç†
    time.sleep(0.1)
    
    result = json.dumps(data, indent=2)
    print(f"Test result: {result}")
    return result

if __name__ == "__main__":
    test_function()
EOF
    
    # æµ‹è¯•æŠ€èƒ½å‘ç°ç³»ç»Ÿèƒ½å¦è¯†åˆ«æ–°ä»£ç 
    if ./scripts/gg-skill-discovery analyze "$test_file" > /dev/null 2>&1; then
        record_test "æŠ€èƒ½å‘ç°ä»£ç åˆ†æ" "PASS"
    else
        record_test "æŠ€èƒ½å‘ç°ä»£ç åˆ†æ" "FAIL" "æ— æ³•åˆ†æä»£ç æ–‡ä»¶"
    fi
    
    # æµ‹è¯•æ€§èƒ½ç›‘æ§
    if ./scripts/gg-performance monitor "python3 $test_file" > /dev/null 2>&1; then
        record_test "æ€§èƒ½ç›‘æ§é›†æˆ" "PASS"
    else
        record_test "æ€§èƒ½ç›‘æ§é›†æˆ" "FAIL" "æ— æ³•ç›‘æ§æ‰§è¡Œ"
    fi
    
    # æµ‹è¯•å®‰å…¨éªŒè¯
    if ./scripts/gg-security validate user read "$test_file" > /dev/null 2>&1; then
        record_test "å®‰å…¨éªŒè¯é›†æˆ" "PASS"
    else
        record_test "å®‰å…¨éªŒè¯é›†æˆ" "FAIL" "å®‰å…¨éªŒè¯å¤±è´¥"
    fi
    
    # æ¸…ç†æµ‹è¯•æ–‡ä»¶
    rm -f "$test_file"
}

# æµ‹è¯•æ•°æ®æµ
test_data_flow() {
    log_info "æµ‹è¯•ç³»ç»Ÿé—´æ•°æ®æµ..."
    
    # æ£€æŸ¥æ—¥å¿—ç›®å½•
    if [ -d "logs" ] && [ "$(ls -A logs 2>/dev/null)" ]; then
        record_test "æ—¥å¿—æ•°æ®æµ" "PASS"
    else
        record_test "æ—¥å¿—æ•°æ®æµ" "FAIL" "æ—¥å¿—ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
    fi
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶åŒæ­¥
    local config_files=("config/performance_config.json" "config/ux_config.json" "config/security_config.json" "config/knowledge_config.json")
    local config_ok=true
    
    for config_file in "${config_files[@]}"; do
        if [ ! -f "$config_file" ]; then
            config_ok=false
            break
        fi
    done
    
    if [ "$config_ok" = true ]; then
        record_test "é…ç½®æ–‡ä»¶åŒæ­¥" "PASS"
    else
        record_test "é…ç½®æ–‡ä»¶åŒæ­¥" "FAIL" "é…ç½®æ–‡ä»¶ç¼ºå¤±"
    fi
    
    # æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„
    local data_dirs=("data/knowledge" "skills" "state" "quality")
    local data_ok=true
    
    for data_dir in "${data_dirs[@]}"; do
        if [ ! -d "$data_dir" ]; then
            data_ok=false
            break
        fi
    done
    
    if [ "$data_ok" = true ]; then
        record_test "æ•°æ®ç›®å½•ç»“æ„" "PASS"
    else
        record_test "æ•°æ®ç›®å½•ç»“æ„" "FAIL" "æ•°æ®ç›®å½•ç¼ºå¤±"
    fi
}

# æµ‹è¯•APIå…¼å®¹æ€§
test_api_compatibility() {
    log_info "æµ‹è¯•APIå…¼å®¹æ€§..."
    
    # æµ‹è¯•Pythonæ¨¡å—è¯­æ³•æ£€æŸ¥
    local python_modules=("scripts/skill_discovery_engine.py" "scripts/performance_monitor.py" "scripts/ux_optimizer.py" "scripts/security_manager.py" "scripts/knowledge_graph.py")
    local import_ok=true
    
    for module in "${python_modules[@]}"; do
        if ! python3 -m py_compile "$module" > /dev/null 2>&1; then
            import_ok=false
            break
        fi
    done
    
    if [ "$import_ok" = true ]; then
        record_test "Pythonæ¨¡å—å…¼å®¹æ€§" "PASS"
    else
        record_test "Pythonæ¨¡å—å…¼å®¹æ€§" "FAIL" "æ¨¡å—å¯¼å…¥å¤±è´¥"
    fi
    
    # æµ‹è¯•Shellè„šæœ¬æ‰§è¡Œæƒé™
    local shell_scripts=("scripts/gg-skill-discovery" "scripts/gg-performance" "scripts/gg-ux" "scripts/gg-security" "scripts/gg-knowledge")
    local exec_ok=true
    
    for script in "${shell_scripts[@]}"; do
        if [ ! -x "$script" ]; then
            exec_ok=false
            break
        fi
    done
    
    if [ "$exec_ok" = true ]; then
        record_test "Shellè„šæœ¬æ‰§è¡Œæƒé™" "PASS"
    else
        record_test "Shellè„šæœ¬æ‰§è¡Œæƒé™" "FAIL" "è„šæœ¬ç¼ºå°‘æ‰§è¡Œæƒé™"
    fi
}

# ç”Ÿæˆé›†æˆæµ‹è¯•æŠ¥å‘Š
generate_report() {
    local report_file="outputs/integration_test_report_$(date +%Y%m%d_%H%M%S).md"
    
    cat > "$report_file" << EOF
# ggæ™ºèƒ½ä½“ç³»ç»Ÿé›†æˆæµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
**æµ‹è¯•ç‰ˆæœ¬**: $(git rev-parse --short HEAD 2>/dev/null || echo "æœªçŸ¥")

## æµ‹è¯•æ¦‚è§ˆ

- **æ€»æµ‹è¯•æ•°**: $TOTAL_TESTS
- **é€šè¿‡æµ‹è¯•**: $PASSED_TESTS
- **å¤±è´¥æµ‹è¯•**: $FAILED_TESTS
- **æˆåŠŸç‡**: $(( PASSED_TESTS * 100 / TOTAL_TESTS ))%

## æµ‹è¯•ç»“æœè¯¦æƒ…

EOF
    
    for result in "${TEST_RESULTS[@]}"; do
        echo "- $result" >> "$report_file"
    done
    
    cat >> "$report_file" << EOF

## ç³»ç»ŸçŠ¶æ€å¿«ç…§

### æŠ€èƒ½å‘ç°ç³»ç»Ÿ
\`\`\`
$(./scripts/gg-skill-discovery status 2>/dev/null || echo "ç³»ç»Ÿå¼‚å¸¸")
\`\`\`

### æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
\`\`\`
$(./scripts/gg-performance status 2>/dev/null || echo "ç³»ç»Ÿå¼‚å¸¸")
\`\`\`

### UXä¼˜åŒ–ç³»ç»Ÿ
\`\`\`
$(./scripts/gg-ux status 2>/dev/null || echo "ç³»ç»Ÿå¼‚å¸¸")
\`\`\`

### å®‰å…¨ç®¡ç†ç³»ç»Ÿ
\`\`\`
$(./scripts/gg-security status 2>/dev/null || echo "ç³»ç»Ÿå¼‚å¸¸")
\`\`\`

### çŸ¥è¯†å›¾è°±ç³»ç»Ÿ
\`\`\`
$(./scripts/gg-knowledge status 2>/dev/null || echo "ç³»ç»Ÿå¼‚å¸¸")
\`\`\`

## å»ºè®®

EOF
    
    if [ $FAILED_TESTS -eq 0 ]; then
        echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œç³»ç»Ÿé›†æˆçŠ¶æ€è‰¯å¥½ã€‚" >> "$report_file"
    else
        echo "âš ï¸ å‘ç° $FAILED_TESTS ä¸ªé—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥å¤±è´¥çš„æµ‹è¯•é¡¹ç›®ã€‚" >> "$report_file"
    fi
    
    log_success "é›†æˆæµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

# ä¸»å‡½æ•°
main() {
    case "${1:-test}" in
        "test")
            log_info "å¼€å§‹ggæ™ºèƒ½ä½“ç³»ç»Ÿé›†æˆæµ‹è¯•..."
            echo "==========================================="
            
            check_system_status
            test_system_integration
            test_data_flow
            test_api_compatibility
            
            echo "==========================================="
            log_info "é›†æˆæµ‹è¯•å®Œæˆ"
            log_info "æ€»æµ‹è¯•: $TOTAL_TESTS, é€šè¿‡: $PASSED_TESTS, å¤±è´¥: $FAILED_TESTS"
            
            generate_report
            
            if [ $FAILED_TESTS -eq 0 ]; then
                log_success "ğŸ‰ æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ï¼"
                exit 0
            else
                log_error "âŒ é›†æˆæµ‹è¯•å‘ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æŠ¥å‘Š"
                exit 1
            fi
            ;;
        "status")
            log_info "ggæ™ºèƒ½ä½“ç³»ç»Ÿé›†æˆçŠ¶æ€:"
            check_system_status
            ;;
        "help")
            echo "ggæ™ºèƒ½ä½“ç³»ç»Ÿé›†æˆæµ‹è¯•å·¥å…·"
            echo ""
            echo "ç”¨æ³•: $0 <command>"
            echo ""
            echo "å‘½ä»¤:"
            echo "  test     è¿è¡Œå®Œæ•´é›†æˆæµ‹è¯•"
            echo "  status   æ£€æŸ¥ç³»ç»Ÿé›†æˆçŠ¶æ€"
            echo "  help     æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
            ;;
        *)
            log_error "æœªçŸ¥å‘½ä»¤: $1"
            echo "ä½¿ç”¨ '$0 help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"